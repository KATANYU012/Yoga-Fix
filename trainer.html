<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>AI Yoga Trainer | SmartYoga AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
</head>
<body>

    <h1>AI Yoga Trainer</h1>
    <h1 id="feedback">-</h1>

    <div class="container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas" width="640" height="480"></canvas>
        <div class="loading" id="loading">
            <p>⌛ กำลังเปิดกล้องและโหลดโมเดล AI...</p>
        </div>
    </div>

    <div id="angle-feedback" class="feedback-panel">
        <ul id="angle-list"></ul>
    </div>
    <script type="module">
        // --- ส่วนที่ 1: ตั้งค่าพื้นฐาน ---
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingElement = document.getElementById('loading');
        const feedbackElement = document.getElementById('feedback');
        const angleListElement = document.getElementById('angle-list'); 

        let masterPoseData = null;
        const urlParams = new URLSearchParams(window.location.search);
        const POSE_TO_CHECK = urlParams.get('pose') || 'Unknown Pose';
        document.querySelector('h1').textContent = `AI Trainer: ${POSE_TO_CHECK}`; 

        let correctPoseTimer = null;
        const POSE_HOLD_DURATION = 3000;
        let isPoseSaved = false;

        // --- ส่วนที่ 2: เครื่องมือคำนวณมุม ---
        function calculateAngle(p1, p2, p3) {
            const angle = Math.atan2(p3.y - p2.y, p3.x - p2.x) - Math.atan2(p1.y - p2.y, p1.x - p2.x);
            let degrees = Math.abs(angle * 180.0 / Math.PI);
            return degrees > 180.0 ? 360 - degrees : degrees;
        }

        // --- ส่วนที่ 3: ฟังก์ชันหลัก onResults ---
        function onResults(results) {
            loadingElement.style.display = 'none';
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, { color: '#c5a878', lineWidth: 3 });
                drawLandmarks(canvasCtx, results.poseLandmarks, { color: '#f0f0f0', lineWidth: 1, radius: 3 });
            }

            if (results.poseLandmarks && masterPoseData && masterPoseData[POSE_TO_CHECK]) {
                let overallCorrect = true;
                let feedbackHtml = '';
                const targetAngles = masterPoseData[POSE_TO_CHECK].angles;
                const landmarks = results.poseLandmarks;
                const landmarkMap = {
                    shoulder: 11, elbow: 13, wrist: 15,
                    hip: 23, knee: 25, ankle: 27
                };

                for (const angleName in targetAngles) {
                    const angleInfo = targetAngles[angleName];
                    let isAnySideCorrect = false;

                    // ตรวจสอบทั้งซ้ายและขวา
                    ['left_', 'right_'].forEach(side => {
                        const p1 = landmarks[landmarkMap[angleInfo.p1] + (side === 'right_' ? 1 : 0)];
                        const p2 = landmarks[landmarkMap[angleInfo.p2] + (side === 'right_' ? 1 : 0)];
                        const p3 = landmarks[landmarkMap[angleInfo.p3] + (side === 'right_' ? 1 : 0)];

                        if(p1 && p2 && p3 && !isAnySideCorrect) {
                            const userAngle = calculateAngle(p1, p2, p3);
                            if (userAngle >= angleInfo.min && userAngle <= angleInfo.max) {
                                isAnySideCorrect = true;
                            }
                        }
                    });

                    if (!isAnySideCorrect) {
                        overallCorrect = false;
                    }
                    feedbackHtml += `<li class="${isAnySideCorrect ? 'correct-angle' : 'incorrect-angle'}">${isAnySideCorrect ? '✔️' : '❌'} ${angleName}</li>`;
                }
                
                angleListElement.innerHTML = feedbackHtml;
                
                // อัปเดตสถานะหลักและจัดการการจับเวลา
                if (!isPoseSaved) {
                    if (overallCorrect) {
                        feedbackElement.style.color = 'lightgreen';
                        if (!correctPoseTimer) {
                            feedbackElement.textContent = 'HOLD...';
                            correctPoseTimer = setTimeout(() => {
                                feedbackElement.textContent = 'SAVED!';
                                isPoseSaved = true;
                                saveResultToDatabase('correct');
                            }, POSE_HOLD_DURATION);
                        }
                    } else {
                        feedbackElement.textContent = 'INCORRECT';
                        feedbackElement.style.color = 'tomato';
                        clearTimeout(correctPoseTimer);
                        correctPoseTimer = null;
                    }
                }
            }
            canvasCtx.restore();
        }

        // --- ส่วนที่ 4: ฟังก์ชันส่งข้อมูลไปบันทึก ---
        function saveResultToDatabase(result) {
            fetch('/smartyoga-api/save_progress.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pose_name: POSE_TO_CHECK, result: result }),
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => console.log('Save progress response:', data.message))
            .catch(error => console.error('Error saving progress:', error));
        }

        // --- ส่วนที่ 5: โหลดข้อมูลและเริ่มต้น ---
        function initializeTrainer() {
            const pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
            pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
            pose.onResults(onResults);

            const camera = new Camera(videoElement, {
                onFrame: async () => { await pose.send({ image: videoElement }); },
                width: 640,
                height: 480
            });
            camera.start();
        }

        fetch('/frontend-user/poses_data.json')
            .then(response => response.json())
            .then(data => {
                masterPoseData = data;
                initializeTrainer();
            });
    </script>

</body>
</html>